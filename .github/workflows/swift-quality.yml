name: Swift Code Quality

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Install SwiftLint
      run: brew install swiftlint
      
    - name: Run SwiftLint
      run: |
        # Create a basic SwiftLint config if it doesn't exist
        if [ ! -f .swiftlint.yml ]; then
          echo "Creating basic SwiftLint configuration..."
          cat > .swiftlint.yml << EOF
        disabled_rules:
          - trailing_whitespace
        opt_in_rules:
          - empty_count
        excluded:
          - Pods
          - build
          - DerivedData
        line_length:
          warning: 150
          error: 200
        EOF
        fi
        
        swiftlint lint --strict || echo "SwiftLint found issues - review warnings"
        
  swift-format:
    name: Swift Format Check
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Check Swift Files Exist
      run: |
        echo "Swift files in project:"
        find . -name "*.swift" -type f ! -path "*/build/*" ! -path "*/DerivedData/*" ! -path "*/.build/*"
        
    - name: Swift Syntax Check
      run: |
        echo "Running Swift syntax validation..."
        for file in $(find . -name "*.swift" -type f ! -path "*/build/*" ! -path "*/DerivedData/*" ! -path "*/.build/*"); do
          echo "Checking $file"
          xcrun swiftc -typecheck "$file" -sdk $(xcrun --show-sdk-path --sdk iphonesimulator) -target arm64-apple-ios17.0 || echo "Syntax check warning for $file"
        done
